## 数据库添加文件集合 files
```
file 文件 非空 最大大小 8_000_000_000 即约8GB
fileSize 文件大小字节数 数字，大于或等于-1的整数，-1表示未知
fileType 文件类型 MIME 字符串
fileName 文件名 字符串
description 描述 字符串
keyword 关键词 字符串
author 上传者 非空
isDeleted 软删除
```

## users 集合添加字段
```
canUploadFile
是否能上传文件 select "YES" | "NO" | ""（N/A）
默认为 N/A

maxUploadFileSize
所能上传文件的最大大小（字节数） number 大于或等于0的整数
默认为0
为 0 时系统将根据 config 集合中的 user-can-upload-image-default 配置决定所能上传文件的最大大小
注意，maxUploadFileSize 或 user-can-upload-image-default 都仅仅是给前端提供数据，是由前端来进行大小限制的，因为pocketbase暂不支持在api规则中限制文件大小
canUploadFile 倒是可以确保的，前后端双重限制
```

## message集合添加字段
```
file 关系字段，单个
```

## config 集合添加配置值
```
user-can-upload-file-default
当用户集合字段canUploadFile未配置时，是否默认允许上传图片，为布尔值
默认为 true

user-max-upload-file-size-default
当用户集合字段maxUploadFileSize为0时，将根据此值决定所能上传文件的最大大小（字节数）
为正整数，大于0的整数
默认为 20000000 即 20MB
```

## 实现规划
```
前后端改 config 集合添加配置值
users集合 添加字段 修改api规则
files集合创建 设置字段 设置api规则
message集合添加字段
导出json，前端生成类型
```

## 集合api规则

### users集合 api规则
在创建规则与更新规则，进行部分修改即可
```c
// ...
// 资源本身的可访问性条件
// ...

  // 这些值不能由用户控制，不能设置
  @request.body.canSendMessage:isset = false &&
  @request.body.canUploadImage:isset = false &&
  @request.body.canUploadFile:isset = false &&
  @request.body.maxUploadFileSize:isset = false &&
  @request.body.isBanned:isset = false

// ...
```

### files 集合 api 规则

#### files集合 查看规则
```c
// 访问主体的前置条件 ，根据配置值判断未登录用户是否可以查看
(
  // 用户已登录，可以查看
  @request.auth.id != '' ||
  // 根据config，判断是否允许未登录用户查看
  (
    @collection.config:allowAnonymousView.key ?= 'allow-anonymous-view' &&
    @collection.config:allowAnonymousView.value ?= true
  )
) &&
// 访问主体的权限条件，isBanned需为false
(
  // 用户未登录时可通过，因为匿名访问已在前置条件控制
  @request.auth.id = '' ||
  // 用户已登录，检查其isBanned 为 false 才能通过
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  )
)
```

#### files集合 创建规则
```c
// 访问主体的前置条件，需登录
@request.auth.id != '' &&
// 访问主体的权限条件，非isBanned 且 判断canUploadFile
(
  // 非isBanned，且
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  ) &&
  // 判断canUploadFile，为YES，或，为空且默认允许
  (
    // canUploadFile 为 YES，或
    (
      @collection.users:canUploadFileCheckYES.id ?= @request.auth.id &&
      @collection.users:canUploadFileCheckYES.canUploadFile ?= 'YES'
    ) ||
    // canUploadFile 为空 且 默认允许
    (
      // canUploadFile 为空，且
      (
        @collection.users:canUploadFileCheckEmpty.id ?= @request.auth.id &&
        @collection.users:canUploadFileCheckEmpty.canUploadFile ?= ''
      ) &&
      // 配置中默认允许
      (
        @collection.config:UCUFD.key ?= 'user-can-upload-file-default' &&
        @collection.config:UCUFD.value ?= true
      )
    )
  )
) &&
// 资源本身的可访问性条件，创建时需为创建者（传入的 author 需为当前用户）
@request.body.author = @request.auth.id
```

#### files集合 更新规则
```c
// 访问主体的前置条件，需登录
@request.auth.id != '' &&
// 访问主体的权限条件，非isBanned 且 判断canUploadFile
(
  // 非isBanned，且
  (
    @collection.users:isBannedCheck.id ?= @request.auth.id &&
    @collection.users:isBannedCheck.isBanned ?= false
  ) &&
  // 判断canUploadFile，为YES，或，为空且默认允许
  (
    // canUploadFile 为 YES，或
    (
      @collection.users:canUploadFileCheckYES.id ?= @request.auth.id &&
      @collection.users:canUploadFileCheckYES.canUploadFile ?= 'YES'
    ) ||
    // canUploadFile 为空 且 默认允许
    (
      // canUploadFile 为空，且
      (
        @collection.users:canUploadFileCheckEmpty.id ?= @request.auth.id &&
        @collection.users:canUploadFileCheckEmpty.canUploadFile ?= ''
      ) &&
      // 配置中默认允许
      (
        @collection.config:UCUFD.key ?= 'user-can-upload-file-default' &&
        @collection.config:UCUFD.value ?= true
      )
    )
  )
) &&
// 资源本身的可访问性条件
(
  // 修改需为创建者
  author.id = @request.auth.id &&
  // 禁止修改 author
  @request.body.author:isset = false
)
```


